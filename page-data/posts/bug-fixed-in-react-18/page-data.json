{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/bug-fixed-in-react-18/","result":{"data":{"markdownRemark":{"html":"<h2 id=\"문제\">문제</h2>\n<p>아래와 같은 react 18 버전 코드가 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> MouseEvent<span class=\"token punctuation\">,</span> useEffect<span class=\"token punctuation\">,</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token keyword\">type</span> <span class=\"token punctuation\">{</span> ReactNode <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">DropdownProps</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  target<span class=\"token operator\">:</span> HTMLElement <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  children<span class=\"token operator\">:</span> ReactNode<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Dropdown</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> target<span class=\"token punctuation\">,</span> children <span class=\"token punctuation\">}</span><span class=\"token operator\">:</span> DropdownProps<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>target<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">listener</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'listener executed'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n    document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> document<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>target<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>target<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>children<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>target<span class=\"token punctuation\">,</span> setTarget<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span>HTMLButtonElement <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> MouseEvent<span class=\"token operator\">&lt;</span>HTMLButtonElement<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setTarget</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>currentTarget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Button</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>button</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Dropdown</span></span> <span class=\"token attr-name\">target</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>target<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">dropdown test</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">Dropdown</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> App<span class=\"token punctuation\">;</span></code></pre></div>\n<p>코드 샌드박스 링크: <a href=\"https://codesandbox.io/s/sad-firefly-sphup6?file=/src/App.tsx\">https://codesandbox.io/s/sad-firefly-sphup6?file=/src/App.tsx</a></p>\n<blockquote>\n<p>이 코드에 대해서 간략하게 설명하면, <code class=\"language-text\">target</code>이 <code class=\"language-text\">falsy</code> 값일 경우에는 <code class=\"language-text\">Dropdown</code> 컴포넌트의 listener가 실행되고 있지 않다가 <code class=\"language-text\">target</code>이 <code class=\"language-text\">falsy</code> 값이 아니게 되면, 이벤트 리스너가 부착되는 코드이다.</p>\n</blockquote>\n<p>이 코드의 동작방식을 예측하면, <strong>당연히 처음 버튼을 눌렀을 때, <code class=\"language-text\">target</code>의 값이 초기화되면서, <code class=\"language-text\">document</code>에 listener가 부착되고, 그 이후에 버튼을 다시 눌렀을 때 listener가 실행되는 것을 예상</strong>했다. 그러나 실제 동작방식은 아래의 화면과 같았다.</p>\n<p><img src=\"https://velog.velcdn.com/images/hustle-dev/post/e26326ce-97c4-469f-8212-b7459e60f081/image.gif\" alt=\"\"></p>\n<blockquote>\n<p><strong>버튼을 누르자마자 listener가 실행</strong>된것이다.</p>\n</blockquote>\n<p>react 17에선 같은 코드가 이렇게 동작하지 않고, react 18의 <code class=\"language-text\">createRoot</code>를 사용할 때, 이런 일이 발생하였는데 왜 이런일이 발생한 것일까?</p>\n<h2 id=\"dan-abramov의-답변\">Dan abramov의 답변</h2>\n<p>계속 고민하다가 왜 이렇게 동작하는 지 이해가 안가서 다음과 같이 <a href=\"https://github.com/facebook/react\">facebook/react</a> 레포에 <a href=\"https://github.com/facebook/react/issues/26090\">Issue</a>를 올렸다.</p>\n<p>우선 결론부터 말하면 저 동작은 <strong>의도된 동작</strong>이라는 것이다.</p>\n<blockquote>\n<p>처음에 이 답변을 듣고, 내가 React를 지금까지 잘못 알고 있었나 생각이 들었다.</p>\n</blockquote>\n<p>위 이슈에 달린 Dan의 답변을 토대로 정리해보면 원래 React17에서는 이러한 동작이 <strong>일관성 없게 동작</strong>을 하였다고 한다. 즉, 저렇게 작성을 하여도 어떤 경우에는 <strong>이벤트가 부착만 되고 이벤트 리스너가 실행되지 않는 경우가 있었고</strong>, <strong>이벤트가 동기식으로 처리되어 이벤트 리스너가 실행되는 경우도 있었다</strong>고 한다.</p>\n<p>아래 예시 코드샌드박스를 보면 확인할 수 있다.</p>\n<ul>\n<li>\n<p>React 17에서 이벤트가 동기식으로 처리되는 경우(portal과 함께 사용)\n<a href=\"https://codesandbox.io/s/runtime-glitter-256mit?file=/src/App.js\">https://codesandbox.io/s/runtime-glitter-256mit?file=/src/App.js</a></p>\n</li>\n<li>\n<p>React 17에서 이벤트가 동기식으로 처리되지 않는 경우\n<a href=\"https://codesandbox.io/s/little-cherry-hbvwik?file=/src/App.js\">https://codesandbox.io/s/little-cherry-hbvwik?file=/src/App.js</a></p>\n</li>\n</ul>\n<blockquote>\n<p>즉, 정리해보면 처음 문제의 코드에서 원래 이벤트가 부착이 되고 <code class=\"language-text\">listener</code>가 실행되는 동작이 정상적인 동작이며 17에선 버그였다고 한다. 그림으로 그려보면 아래와 같다.</p>\n</blockquote>\n<p><img src=\"https://velog.velcdn.com/images/hustle-dev/post/c0f02420-0f8c-4ae0-9f01-fe9e0c7f7801/image.png\" alt=\"\"></p>\n<blockquote>\n<p>18에서는 이러한 동작이 일관되어 항상 이벤트를 포착하고, 클릭/입력과 같은 의도적인 사용자 이벤트로 인한 렌더링 효과는 항상 동기적으로 처리 된다고 한다.</p>\n</blockquote>\n<h2 id=\"처음-의도한-대로-코드를-실행시키려면\">처음 의도한 대로 코드를 실행시키려면?</h2>\n<p>우선 Dan이 댓글에 언급한 대로, <code class=\"language-text\">setTimeout</code> 방법이 있다.</p>\n<h3 id=\"settimeout\">setTimeout</h3>\n<p>이벤트의 부착하는 시점을 <code class=\"language-text\">setTimeout</code>으로 감싼다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'click'</span><span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>추후 더 고민해보니 아래와 같은 방법으로도 해결할 수 있었다.</p>\n<h3 id=\"usedeferredvalue\">useDeferredValue</h3>\n<p>기존 코드의 <code class=\"language-text\">target</code>을 사용하는 부분을 <code class=\"language-text\">useDeferredValue</code>로 감싼 값으로 사용한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">const</span> deferredTarget <span class=\"token operator\">=</span> <span class=\"token function\">useDeferredValue</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3 id=\"starttransition\">startTransition</h3>\n<p><code class=\"language-text\">setState</code>하는 부분의 코드를 <code class=\"language-text\">startTransition</code>으로 감싼다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\">      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>button</span>\n        <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> MouseEvent<span class=\"token operator\">&lt;</span>HTMLButtonElement<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">startTransition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">setTarget</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>currentTarget<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span></code></pre></div>\n<h2 id=\"참고자료\">참고자료</h2>\n<ul>\n<li><a href=\"https://github.com/facebook/react/issues/26090\">https://github.com/facebook/react/issues/26090</a></li>\n<li><a href=\"https://github.com/facebook/react/issues/24657\">https://github.com/facebook/react/issues/24657</a></li>\n<li><a href=\"https://github.com/facebook/react/issues/20074\">https://github.com/facebook/react/issues/20074</a></li>\n</ul>","frontmatter":{"date":"23.03.22","description":"이 문제에 대해 아시나요?","heroImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6klEQVR42mNQwgOUVcCkMi55Bpw6FeQVZKQU5eUVpKUVFeRJ0KyooKCub6jv5quirqHn5qumb6iooECcZmVlBRlpfXdf45AYl9bpJmEJei5eCjLSmO5nwNQJttbIKr3EqWGCTX6tU/0Eq4xSmOXKBDQryMkaBUWZhCc6N052qp/gVNdnGp1iFBipKC+HZjk2ZysqKqupWybn25e12Je12pe3WSTnKaupKykqEutnHQc3o8BI+7IW45AYbTsn4vwMs1xFQ1PbxkFBVkbLxl5VUwvTWnzxrKigIC8jDYpvUDwrkJhIQAmMQAoDAO4aanVFhZsCAAAAAElFTkSuQmCC"},"images":{"fallback":{"src":"/static/cba0b89d2bf2d96a1ed26edb5849f804/b5380/heroImage.png","srcSet":"/static/cba0b89d2bf2d96a1ed26edb5849f804/a0e1b/heroImage.png 300w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/86184/heroImage.png 600w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/b5380/heroImage.png 1200w","sizes":"(min-width: 1200px) 1200px, 100vw"},"sources":[{"srcSet":"/static/cba0b89d2bf2d96a1ed26edb5849f804/c7da1/heroImage.webp 300w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/22c65/heroImage.webp 600w,\n/static/cba0b89d2bf2d96a1ed26edb5849f804/81547/heroImage.webp 1200w","type":"image/webp","sizes":"(min-width: 1200px) 1200px, 100vw"}]},"width":1200,"height":630}}},"heroImageAlt":"타입스크립트","tags":["TypeScript","번역"],"title":"React 18에서 고쳐진 버그 (feat. Dan의 답변)"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C\">문제</a></p>\n</li>\n<li>\n<p><a href=\"#dan-abramov%EC%9D%98-%EB%8B%B5%EB%B3%80\">Dan abramov의 답변</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B2%98%EC%9D%8C-%EC%9D%98%EB%8F%84%ED%95%9C-%EB%8C%80%EB%A1%9C-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%8B%A4%ED%96%89%EC%8B%9C%ED%82%A4%EB%A0%A4%EB%A9%B4\">처음 의도한 대로 코드를 실행시키려면?</a></p>\n<ul>\n<li><a href=\"#settimeout\">setTimeout</a></li>\n<li><a href=\"#usedeferredvalue\">useDeferredValue</a></li>\n<li><a href=\"#starttransition\">startTransition</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\">참고자료</a></p>\n</li>\n</ul>"}},"pageContext":{"id":"9f449c7b-a9c5-50d6-8e5a-e0416608acc4","frontmatter__slug":"/bug-fixed-in-react-18","previous":"/velog-to-gatsby-blog","previousTitle":"velog to Gatsby 블로그 이전기","next":"/translate-ts-5-0","nextTitle":"TypeScript 5.0 번역"}},"staticQueryHashes":["1485575810"],"slicesMap":{}}