{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/release-yarn4/","result":{"data":{"markdownRemark":{"html":"<!-- 썸네일 -->\n<!-- 본문 -->\n<p>Yarn 4.0이 출시되었다. 블로그의 글을 읽어보면서 무엇이 변경되었고 그동안 자세하게 알고싶었던 yarn에서 사용하는 개념을 알아보고자 한다.</p>\n<h2 id=\"주요-변경-사항\">주요 변경 사항</h2>\n<p>yarn 4.0에선 아래와 같은 것들이 변경되었다.</p>\n<ul>\n<li>Node.js 18 이상 버전이 필요</li>\n<li><code class=\"language-text\">yarn init</code>으로 생성된 프로젝트에서 더 이상 Zero-install을 활성화하지 않음</li>\n<li><code class=\"language-text\">yarn init</code>으로 생성된 프로젝트는 <code class=\"language-text\">yarnPath</code>가 아닌 <code class=\"language-text\">Corepack</code>을 사용</li>\n<li>모든 공식 플러그인(타입스크립트, 인터랙티브 도구)이 기본적으로 포함</li>\n<li><code class=\"language-text\">yarn workspace foreach</code> 명령의 구문이 약간 변경</li>\n</ul>\n<blockquote>\n<p>읽다보니 여기서 궁금한 키워드가 생겼다. <code class=\"language-text\">Zero-install</code>, <code class=\"language-text\">yarnPath</code>, <code class=\"language-text\">Corepack</code>에 대해 알아보자.</p>\n</blockquote>\n<h3 id=\"zero-install\">Zero-install</h3>\n<p>yarn 문서의 <a href=\"https://yarnpkg.com/features/caching#zero-installs\">Zero-install</a>에는 <strong>브랜치 전환시 <code class=\"language-text\">yarn install</code>을 하지 않아 발생하는 문제를 해결해주는 캐시전략 패턴이라 한다.</strong> 즉, 저장소 내 <code class=\"language-text\">.yarn/cache</code>에 <code class=\"language-text\">zip</code> 파일 형태로 의존성을 관리하고, 이를 <code class=\"language-text\">.pnp.cjs</code> 파일에 정보를 등록해 어디서 의존성을 찾아야하는지 알 수 있어 따로 <code class=\"language-text\">yarn install</code>을 해주지 않아도 된다.</p>\n<p>Zero-install 개념을 찾아보다가 <a href=\"https://toss.tech/article/node-modules-and-yarn-berry\">node_modules로부터 우리를 구원해 줄 Yarn Berry</a>를 보았는데 잘 정리되어 있어 보는 것을 추천한다. 기존 yarn v1과 npm에서 어떤 문제가 있었고 이를 해결하기 위한 Plug'n'Play(PnP)의 장점을 소개한다. 이 과정에서 yarn berry로 설치할 때 생기는 파일인 <code class=\"language-text\">pnp.cjs</code>가 어떤 역할을 하는지, zero-install을 위해 파일을 어떻게 관리하는지 자세히 알 수 있다.</p>\n<h3 id=\"yarnpath\">yarnPath</h3>\n<img width=\"450\" alt=\"image\" src=\"https://github.com/hustle-dev/hustle-dev.github.io/assets/53992007/a2090c25-f1c5-46e1-b2f9-9ea96d18a73e\">\n<blockquote>\n<p>프로젝트안의 <code class=\"language-text\">.yarnrc.yml</code> 파일을 볼 때마다 항상 '이 설정은 뭐지?' 라고 궁금해했다.</p>\n</blockquote>\n<p><a href=\"https://yarnpkg.com/configuration/yarnrc#yarnPath\">yarnPath</a>은 글로벌 경로 대신 사용할 Yarn 바이너리의 경로이다.</p>\n<p>일반적으로 <code class=\"language-text\">yarnPath</code>은 <code class=\"language-text\">yarnrc.yml</code>의 아래와 같은 형식으로 저장되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">yarnPath</span><span class=\"token punctuation\">:</span> .yarn/releases/yarn<span class=\"token punctuation\">-</span>3.6.4.cjs</code></pre></div>\n<blockquote>\n<p>여기서 <code class=\"language-text\">yarn-3.6.4.cjs</code> 파일의 역할은 해당 프로젝트 내에서 <strong>Yarn 명령을 실행하는 데 사용되는 yarn 바이너리의 특정 버전</strong>이다. 즉, Yarn 3.6.4 버전에 대한 Yarn 실행 파일이 포함되어 있다.</p>\n</blockquote>\n<p>현재 공식문서에는 <code class=\"language-text\">yarnPath</code> 설정보다 대부분의 경우 <code class=\"language-text\">Corepack</code>을 사용하는 것이 좋다고 한다.</p>\n<h3 id=\"corepack\">Corepack</h3>\n<p><a href=\"https://nodejs.org/api/corepack.html\">Corepack</a>은 패키지 매니저 버전을 관리하는 데 도움이 되는 실험적인 도구로, node와 패키지 매니저 간 브릿지 역할을 한다.</p>\n<blockquote>\n<p>Corepack을 사용하면 <code class=\"language-text\">Yarn, npm, pnpm</code>을 설치할 필요없이 사용할 수 있다.</p>\n</blockquote>\n<p>Corepack을 사용하면 <code class=\"language-text\">yarn</code>을 사용하고 있는 프로젝트인데 <code class=\"language-text\">pnpm</code>을 사용해 명령어 입력시 올바른 패키지 매니저(yarn)를 사용해 명령을 다시 실행하도록 요청한다. <code class=\"language-text\">yarn</code>을 사용해 명령어를 입력하면 Corepack은 호환 가능한 최신 버전을 자동으로 다운로드하여 캐시한다.</p>\n<h2 id=\"yarn-설치하기\">Yarn 설치하기</h2>\n<p><code class=\"language-text\">yarnPath</code> 설정을 2.0버전부터 지원하고 권장했지만 사람들이 저장소에 이런 바이너리를 추가하는 것을 좋아하지 않았다고 한다. 따라서 Corepack이 등장하게 되었고 이는 작업 중인 프로젝트에 맞는 올바른 패키지 관리자 버전을 자동으로 선택해준다.</p>\n<p>더이상 <code class=\"language-text\">yarnPath</code>에 의존할 필요가 없고 <code class=\"language-text\">package.json</code>의 <code class=\"language-text\">packageManager</code> 필드를 업데이트 하도록 <code class=\"language-text\">yarn init -2</code> 및 <code class=\"language-text\">yarn set version</code> 명령이 업데이트 되었다.</p>\n<blockquote>\n<p>Corepack은 <code class=\"language-text\">package.json</code>의 <code class=\"language-text\">packageManager</code> 필드를 보고 어떤 패키지 관리자 버전을 사용할지 알 수 있다. 이 필드는 보통 <code class=\"language-text\">corepack use yarn@x.y.z</code> 명령어를 활용해 설정된다.</p>\n</blockquote>\n<h2 id=\"강화모드\">강화모드</h2>\n<p>yarn 4.0에선 사용자를 보호하기 위해 강화모드를 도입했다. 여기서 두 가지 추가 유효성 검사를 수행한다.</p>\n<ul>\n<li>lockfile에 저장된 resolution이 해당 범위로 resolve 될 수 있는 것과 일치하는지 검증한다.</li>\n<li>lockfile에 저장된 패키지 메타데이터가 원격 레지스트리 메타데이터와 일치하는지 확인한다.</li>\n</ul>\n<p>이를 통해 공격자가 yarn을 사용해 프로젝트에 PR을 할 때 잠금 파일을 몰래 수정하는 것을 방지할 수 있다.</p>\n<blockquote>\n<p><a href=\"https://snyk.io/blog/why-npm-lockfiles-can-be-a-security-blindspot-for-injecting-malicious-modules/\">예시</a>에선 github PR에서 <code class=\"language-text\">yarn.lock</code>파일이 <code class=\"language-text\">Load diff</code> 뜨면서 무엇을 수정했는지 알 수 없어서 이 부분이 취약점이 될 수 있음을 말함</p>\n</blockquote>\n<p>강화모드는 <code class=\"language-text\">enableHardenedMode</code>를 켜서 활성화할 수 있고, <code class=\"language-text\">yarnrc</code> 파일에서 명시적으로 해제하여 비활성화할 수 있다. 다만 이 제약 조건은 많은 네트워크 요청을 수행해야해서 CI와 같은 환경에서는 환경 변수를 통해 기본적으로 활성화하지 않게 할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">export YARN_ENABLE_HARDENED_MODE=1</code></pre></div>\n<h2 id=\"js-제약조건\">JS 제약조건</h2>\n<p>기존 yarn에서는 <a href=\"https://en.wikipedia.org/wiki/Prolog#Rules_and_facts\">Prolog</a>라는 <a href=\"https://yarnpkg.com/features/constraints\">constraints engine</a>을 사용했다.</p>\n<blockquote>\n<p>여기서 constraints engine이란 <strong>모든 워크스페이스에 자동으로 특정한 규칙을 적용하기 위한 것</strong>이다.</p>\n</blockquote>\n<p>그러나 이는 사용하기 매우 복잡해 Yarn 4부터 더 이상 사용되지 않고 TS를 지원하는 새 JS기반 엔진으로 대체되었다.</p>\n<p>새로운 선택 사항인 <code class=\"language-text\">enableConstraintsChecks</code> 설정은 Yarn이 Yarn 설치의 일부로 제약 조건을 실행하도록 한다. 원격 CI가 오류를 발생시킬 때까지 기다리기 전에 오류를 발견할 수 있는 편리한 방법이며, 새 엔진이 매우 빠르기 때문에 설치 시간에 거의 영향을 미치지 않는다고 한다.</p>\n<h2 id=\"타입스크립트-통합-인터렉티브-도구\">타입스크립트 통합, 인터렉티브 도구</h2>\n<p>이제 플러그인 없이 <code class=\"language-text\">yarn upgrade-interactive</code>와 <code class=\"language-text\">yarn stage</code>를 사용할 수 있고, 프로젝트에 TS가 구성되어 있는 경우 <code class=\"language-text\">yarn</code>은 종속성을 업데이트할 때마다 필요에 따라 <code class=\"language-text\">@types</code> 패키지를 자동으로 추가 및 제거한다.</p>\n<h2 id=\"성능\">성능</h2>\n<p>제시된 상황(콜드 캐시에서 개츠비와 약 350MiB 종속성 트리를 설치)에서 기존 3.6버전 보다 설치 속도가 약 3배 빨라졌다. 이는 대부분의 시나리오에서 <code class=\"language-text\">pnpm</code>만큼 빨라진 결과를 보인다고 한다.</p>\n<h2 id=\"참고링크\">참고링크</h2>\n<ul>\n<li><a href=\"https://yarnpkg.com/blog/release/4.0\">Release: Yarn 4.0</a></li>\n<li><a href=\"https://toss.tech/article/node-modules-and-yarn-berry\">node_modules로부터 우리를 구원해 줄 Yarn Berry</a></li>\n<li><a href=\"https://github.com/nodejs/corepack\">nodejs/corepack</a></li>\n</ul>","frontmatter":{"date":"23.10.26","description":"이번에 릴리즈된 Yarn 4.0을 읽어보면서 모르는 개념을 같이 학습한 글입니다.","heroImage":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAADEUlEQVR42h2RW2xTBRyHjw9e1i0EjLKMUnth6zo22p61p10va7udrpSta2ll7TjrDcIusg62MsD1QrN1MEjUwpQtOF1MUAny5KOJiQ++6IuJbz76qLwYiVETHj4PPnzJL/knv3z5/QVbf4FkvIbTNo9jYAG/8zLDzmUCzhVG3VcIu8uMuZeR1azIO9Q8RTY8WZrBJc6Hthh1VRkPtIgFPiByIo3QZ54i4FvA2pdTKSBZL+CyzuJW8dnn8Kv47LNExXlagSKPUk3upBoUh4pMSyUSoc9wilVCrg1OeW8hGPXj6LqimHSTmI0pzIYUx4+lsfcqiBYFqU9hwJxh3lfk6/wlFsOzZNxpJh05TloLlEN1PLYVvK5b+F23EXTaEE77C8sCDlsGOXABjyOLWR+j1xCjzzChEkO2vk3YnsTyVgSrPsJx/QgZtbTkfQfJnCDUHcRpCCEcfkNiJJBlempF3XKRfPba/1kcOI1bPIPP8cJ2AosxTK8uyIA+RI/Oj8PgJS8pKINncWpFLK+biPX4ELpVQ7v9FLI8Q2Qsz7Avw8lwkTE5R2z8HPHYOdVYLbfGsfZE6DnqxWP0UB2apOQuUHFEOW0SebPjKIpZQvCbs8QGLzIq5vD2n8FqjtLfHSYsFki4F8n6qizIN9Xd5lGkGRalJHsjSfblLLvBKb6NyFwTh2l/rQvx8DGE68F1VkdaLIXuMue/Q2FondRgmfNDm1yXP+FqYJOrboWaNE5lMMj2cJwvIik+jU7zTWKKX/Lqw044OdTWSWdHF8KzykO+m/2QJ4UWT/L3eZzf4XFul0dnWzzM3OZzpaLeynyVv8KX+RV+vFzl1/INnq41eL6+xd+Ne8QtLg6+chBtxxGEny41+Xl5ix+W3udp9QG/v3uXP6rb/HnjPv80tvl34wG/Nfb4q7kHW/s8v7nHs3qL7+fq7CRLzLkn6Dygp6PtCO0aLUI1UaeZrLEWX+O9qTr30hU+Vqp8lF5jf6bO7nSFZnyVzclVatGLlEJFRvsnOHDIhvCqiZde1tKmMaLR6NG0m/gPyWq0exLvLjwAAAAASUVORK5CYII="},"images":{"fallback":{"src":"/static/440faa69e06c086eefcc63b59375a2e9/280ad/heroImage.png","srcSet":"/static/440faa69e06c086eefcc63b59375a2e9/69767/heroImage.png 721w,\n/static/440faa69e06c086eefcc63b59375a2e9/7733b/heroImage.png 1442w,\n/static/440faa69e06c086eefcc63b59375a2e9/280ad/heroImage.png 2884w","sizes":"(min-width: 2884px) 2884px, 100vw"},"sources":[{"srcSet":"/static/440faa69e06c086eefcc63b59375a2e9/5c9be/heroImage.webp 721w,\n/static/440faa69e06c086eefcc63b59375a2e9/eadea/heroImage.webp 1442w,\n/static/440faa69e06c086eefcc63b59375a2e9/e6b5a/heroImage.webp 2884w","type":"image/webp","sizes":"(min-width: 2884px) 2884px, 100vw"}]},"width":2884,"height":1614}}},"heroImageAlt":"Yarn","tags":["Yarn"],"title":"Yarn 4.0 릴리즈를 읽어보면서"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EC%A3%BC%EC%9A%94-%EB%B3%80%EA%B2%BD-%EC%82%AC%ED%95%AD\">주요 변경 사항</a></p>\n<ul>\n<li><a href=\"#zero-install\">Zero-install</a></li>\n<li><a href=\"#yarnpath\">yarnPath</a></li>\n<li><a href=\"#corepack\">Corepack</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#yarn-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0\">Yarn 설치하기</a></p>\n</li>\n<li>\n<p><a href=\"#%EA%B0%95%ED%99%94%EB%AA%A8%EB%93%9C\">강화모드</a></p>\n</li>\n<li>\n<p><a href=\"#js-%EC%A0%9C%EC%95%BD%EC%A1%B0%EA%B1%B4\">JS 제약조건</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%83%80%EC%9E%85%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%ED%86%B5%ED%95%A9-%EC%9D%B8%ED%84%B0%EB%A0%89%ED%8B%B0%EB%B8%8C-%EB%8F%84%EA%B5%AC\">타입스크립트 통합, 인터렉티브 도구</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%84%B1%EB%8A%A5\">성능</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0%EB%A7%81%ED%81%AC\">참고링크</a></p>\n</li>\n</ul>"}},"pageContext":{"id":"5b3e3916-629a-5d8c-9536-d2dffca1fdbd","frontmatter__slug":"/release-yarn4","previous":null,"previousTitle":null,"next":"/translate-ts-5-2","nextTitle":"TypeScript 5.2 번역"}},"staticQueryHashes":["1485575810"],"slicesMap":{}}